<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobiletix ‚Äì Admin</title>
  <style>
    :root{--blue:#0a74da;--bg:#f5f9ff}
    body{font-family:system-ui, Arial;margin:0;background:var(--bg)}
    header{background:var(--blue);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    main{padding:16px;display:grid;gap:18px}
    .card{background:#fff;border:2px solid var(--blue);border-radius:12px;padding:14px}
    label{display:block;margin:6px 0 2px;font-weight:700}
    input,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #cfe2ff}
    button{margin-top:10px;padding:10px 14px;border:none;border-radius:8px;background:var(--blue);color:#fff;font-weight:800}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .item{border:1px solid #cfe2ff;border-radius:10px;padding:10px;background:#fff}
    .item img{width:100%;height:120px;object-fit:cover;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <strong>Admin Panel</strong>
    <div id="who"></div>
  </header>
  <main>
    <div class="card">
      <h3>üîê Sign in (Google)</h3>
      <button id="login">Login</button>
      <button id="logout">Logout</button>
      <div id="guard" style="margin-top:8px;color:#b00;font-weight:700"></div>
    </div>

    <div class="card">
      <h3>üñºÔ∏è Banner Image URL</h3>
      <label>Banner URL</label>
      <input id="bannerUrl" placeholder="https://..."/>
      <button id="saveBanner">Save Banner</button>
    </div>

    <div class="card">
      <h3>‚ûï Add Product</h3>
      <div class="grid">
        <div>
          <label>‡¶®‡¶æ‡¶Æ</label><input id="pName"/>
          <label>‡¶¶‡¶æ‡¶Æ (‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ)</label><input id="pPrice" type="number"/>
          <label>‡¶∏‡ßç‡¶ü‡¶ï</label><input id="pQty" type="number"/>
          <label>‡¶¨‡¶∞‡ßç‡¶£‡¶®‡¶æ</label><textarea id="pDet" rows="4"></textarea>
        </div>
        <div>
          <label>‡¶õ‡¶¨‡¶ø (‡¶´‡¶æ‡¶á‡¶≤)</label><input id="pImg" type="file" accept="image/*"/>
          <button id="addBtn">Add Product</button>
          <div id="msg"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>üì¶ Products</h3>
      <div id="list" class="list"></div>
    </div>
  </main>

  <script type="module">
    import { firebaseConfig, ADMIN_UID } from './firebase.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const provider = new GoogleAuthProvider();
    const who = document.getElementById('who');
    const guard = document.getElementById('guard');

    document.getElementById('login').onclick = async ()=>{ try{ await signInWithPopup(auth, provider);}catch(e){alert(e.message);} };
    document.getElementById('logout').onclick = async ()=>{ await signOut(auth); };

    function mustAdmin(user){
      if(!user){ guard.textContent = '‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®'; return false; }
      if(user.uid !== ADMIN_UID){ guard.textContent = '‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶®‡¶®!'; return false; }
      guard.textContent = '';
      return true;
    }

    onAuthStateChanged(auth, async (user)=>{
      who.textContent = user ? (user.displayName||user.email) + ' ('+user.uid+')' : '';
      if(mustAdmin(user)) loadProducts();
      else document.getElementById('list').innerHTML='';
      console.log('Your UID:', user?.uid);
    });

    // Save banner URL to Firestore: settings/config
    document.getElementById('saveBanner').onclick = async ()=>{
      if(!mustAdmin(auth.currentUser)) return;
      const url = (document.getElementById('bannerUrl').value||'').trim();
      await setDoc(doc(db,'settings','config'), { bannerUrl: url }, { merge:true });
      alert('Banner saved');
    };

    // Add Product
    document.getElementById('addBtn').onclick = async ()=>{
      if(!mustAdmin(auth.currentUser)) return;
      const name = document.getElementById('pName').value.trim();
      const price = Number(document.getElementById('pPrice').value);
      const qty = Number(document.getElementById('pQty').value);
      const det = document.getElementById('pDet').value.trim();
      const file = document.getElementById('pImg').files[0];
      if(!name || !file){ return alert('‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶õ‡¶¨‡¶ø ‡¶¶‡¶ø‡¶®'); }
      const msg = document.getElementById('msg');
      try{
        msg.textContent = 'Uploading image...';
        const r = ref(storage, 'products/'+Date.now()+'-'+file.name);
        await uploadBytes(r, file);
        const url = await getDownloadURL(r);
        msg.textContent = 'Saving product...';
        await addDoc(collection(db,'products'), {
          name, price, quantity: qty, details: det, imageUrl: url,
          ratingAvg: 0, ratingCount: 0, views: 0, sold: 0,
          createdAt: Date.now()
        });
        msg.textContent = 'Added!';
        loadProducts();
      }catch(e){ alert(e.message); msg.textContent=''; }
    };

    async function loadProducts(){
      const list = document.getElementById('list');
      list.innerHTML='';
      const q = await getDocs(collection(db,'products'));
      q.forEach(d=>{
        const p = d.data();
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <img src="${p.imageUrl}" alt="${p.name}">
          <div><strong>${p.name}</strong></div>
          <div>‡ß≥${p.price} | ‡¶∏‡ßç‡¶ü‡¶ï: ${p.quantity ?? 0}</div>
          <button data-id="${d.id}">Delete</button>
        `;
        el.querySelector('button').onclick = async ()=>{
          if(confirm('‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?')){ await deleteDoc(doc(db,'products', d.id)); loadProducts(); }
        };
        list.appendChild(el);
      });
    }
  </script>
</body>
</html>
